FROM us-docker.pkg.dev/recidiviz-staging/recidiviz-base/default:latest

WORKDIR /app
USER root

# 1. Install Playwright's SYSTEM-LEVEL dependencies *as root*.
# These are necessary libraries for Chromium to run headless on Debian/Ubuntu.
# This list is comprehensive to cover most common headless browser needs.
RUN apt-get update && apt-get install -y --no-install-recommends \
    libatk-bridge2.0-0 \
    libgtk-3-0 \
    libgbm-dev \
    libnss3 \
    libxss1 \
    libfontconfig1 \
    libdrm-dev \
    libxkbcommon-dev \
    libglib2.0-0 \
    libgdk-pixbuf2.0-0 \
    libcairo2 \
    libpango-1.0-0 \
    libpangocairo-1.0-0 \
    libatspi2.0-0 \
    libxcomposite1 \
    libxdamage1 \
    libxfixes3 \
    libxrandr2 \
    libexpat1 \
    libjpeg-turbo8 \
    libpng16-16 \
    libharfbuzz0b \
    libfreetype6 \
    liblcms2-2 \
    libwoff1 \
    libwebpdemux2 \
    libenchant-2-2 \
    libhyphen0 \
    libsecret-1-0 \
    libsqlite3-0 \
    libxml2 \
    libxslt1.1 \
    libicu-dev \
    libevent-core-2.1-7 \
    libevent-pthreads-2.1-7 \
    libnotify4 \
    libflac-dev \
    libogg-dev \
    libopus-dev \
    libvorbis-dev \
    libwebp-dev \
    libzstd1 \
    libavahi-client3 \
    libavahi-common3 \
    libdbus-1-3 \
    libsystemd0 \
    libudev1 \
    && rm -rf /var/lib/apt/lists/* # Clean up apt cache to keep the image size down

# Switch to 'recidiviz' user for subsequent steps that install user-specific tools.
USER recidiviz

# 2. Install Playwright browser BINARIES as the 'recidiviz' user.
# Note: --with-deps is removed because system dependencies are handled above by root.
RUN pipenv run playwright install chromium
