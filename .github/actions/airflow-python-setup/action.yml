name: "Airflow Python Setup"
runs:
  using: "composite"
  steps:
    - name: Use Python 3.11.8
      run: pyenv global 3.11.8
      shell: bash
    - name: Pipenv caching
      uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
      id: pipenv-caching
      with:
        path: ~/.local/share/virtualenvs/
        key: ${{ runner.os }}-${{ runner.arch }}-python-pipenv-airflow-${{ hashFiles('**/recidiviz/airflow/Pipfile.lock') }}
        # If we haven't cached a pipenv for the new version of the lock file this will
        # restore the cache for the most recent version. Since most of the time our
        # lock file updates only change a small number of packages, this speeds up
        # the sync step significantly.
        restore-keys: |
          ${{ runner.os }}-${{ runner.arch }}-python-pipenv-airflow-
    - name: Sync pipenv
      if: steps.pipenv-caching.outputs.cache-hit != 'true'
      # If we didn't find an exact pipenv match, we have to `sync.` Because we may have
      # restored a prior pipenv, we need to also run `clean` to remove any packages that
      # are no longer in our lock file.
      working-directory: ./recidiviz/airflow
      run: |
        pipenv sync --dev
        pipenv clean
      shell: bash
