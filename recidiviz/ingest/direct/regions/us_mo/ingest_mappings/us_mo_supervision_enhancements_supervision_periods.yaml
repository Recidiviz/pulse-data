# yaml-language-server: $schema=./../../../ingest_mappings/yaml_schema/1.0.0/schema.json
# This file associates the columns outputted from the query in `view_tak034_tak026_tak039_apfx90_apfx91_supervision_enhancements_supervision_periods` to
#  corresponding Ingest Object fields.
manifest_language: 1.0.0
input_columns:
  DOC: STRING
  CYC: STRING
  session_id: INTEGER
  start_date: DATE
  end_date: DATE
  LOC_ACRO: STRING
  SUPV_OFFICER_ID: STRING
  CASE_TYPE_LIST: STRING
  SUP_LVL: STRING
  CUSTODY_TYPE_CD: STRING
  START_STATUS_CODE_LIST: STRING
  END_STATUS_CODE_LIST: STRING
unused_columns: []
output:
  StatePerson:
    external_ids:
      - StatePersonExternalId:
          external_id: DOC
          id_type: $literal("US_MO_DOC")
    supervision_periods:
      - StateSupervisionPeriod:
          external_id:
            $concat:
              $values:
                - DOC
                - CYC
                - session_id
          start_date: start_date
          termination_date: end_date
          supervision_site: LOC_ACRO
          admission_reason:
            $enum_mapping:
              $raw_text: START_STATUS_CODE_LIST
              $custom_parser: us_mo_custom_enum_parsers.parse_supervision_period_admission_reason
              $map_null_to: $literal_enum(StateSupervisionPeriodAdmissionReason.TRANSFER_WITHIN_STATE)
          termination_reason:
            $conditional:
              - $if:
                  $and:
                    - $not_null: end_date
                    - $is_null: END_STATUS_CODE_LIST
                $then: $literal_enum(StateSupervisionPeriodTerminationReason.TRANSFER_WITHIN_STATE)
              - $else:
                  $enum_mapping:
                    $raw_text: END_STATUS_CODE_LIST
                    $custom_parser: us_mo_custom_enum_parsers.parse_supervision_period_termination_reason
          supervision_level:
            $enum_mapping:
              $raw_text: SUP_LVL
              $mappings:
                StateSupervisionLevel.ABSCONSION:
                  - "ESC" # Absconder
                  - "ABS" # Absconder/Escape
                StateSupervisionLevel.INTAKE:
                  - "IAP" # Initial Assessment Phase
                  # The following codes are no longer used according to MO, but may appear in historical records
                  - "PSI" # Pre Sentence Investigation
                StateSupervisionLevel.UNSUPERVISED:
                  - "NUS" # Not under supervision
                  - "NSV" # Not Under Supervision (case closed by court/board but still open at district level)
                StateSupervisionLevel.ELECTRONIC_MONITORING_ONLY:
                  - "EMP" # Electronic Monitoring
                StateSupervisionLevel.MINIMUM:
                  - "OOI" # Low Risk (low risk on ORAS)
                  - "LV1" # Level I
                  # The following codes are no longer used according to MO, but may appear in historical records
                  - "NOI" # No Contract Monitoring Level I
                  - "MIN" # Minimum
                  - "MSC" # Automated Minimum
                StateSupervisionLevel.MEDIUM:
                  - "OII" # Moderate Risk (moderate/low or moderate on ORAS)
                  - "LV2" # Level II
                  # The following codes are no longer used according to MO, but may appear in historical records
                  - "NII" # No Contract Monitoring Level II
                  - "REG" # Regular Supervision
                StateSupervisionLevel.HIGH:
                  - "III" # High Risk (high risk on ORAS)
                  - "LV3" # Level III
                  # The following codes are no longer used according to MO, but may appear in historical records
                  - "ENH" # Enhanced
                StateSupervisionLevel.MAXIMUM:
                  - "ISP" # Intensive Supervision (specialized programming + very high risk on ORAS)
                StateSupervisionLevel.IN_CUSTODY:
                  - "ITC" # Institutional Treatment Center
                  - "JAL" # Incarceration/Jail
                  - "PRS" # Incarceration/Prison
                  - "SHK" # 120 Day Incarceration
                  - "PSN" # Prison
                StateSupervisionLevel.RESIDENTIAL_PROGRAM:
                  - "CPP" # Residential Community Placement (treatment)
                  # The following codes are no longer used according to MO, but may appear in historical records
                  - "RTF" # Residential Treatment facility
                  - "VCT" # Residential Violator Center
          supervising_officer_staff_external_id: SUPV_OFFICER_ID
          supervising_officer_staff_external_id_type:
            $conditional:
              - $if:
                  $not_null: SUPV_OFFICER_ID
                $then: $literal("US_MO_STAFF_BADGE_NUMBER")
          # CSC cases can be identified using supervision_period_metadata, which will have {'custody_type': 'CSC'}
          # for CSC cases and {'custody_type': ''} otherwise. We could instead set supervision_level to
          # RESIDENTIAL_PROGRAM for these cases, but storing this information in the metadata field lets
          # us preserve the existing supervision level for these cases, in case it's relevant.
          supervision_period_metadata:
            $normalized_values_json_dict:
              custody_type: CUSTODY_TYPE_CD
          case_type_entries:
            - $foreach:
                $iterable: CASE_TYPE_LIST
                $result:
                  StateSupervisionCaseTypeEntry:
                    case_type:
                      $enum_mapping:
                        $raw_text: $iter_item
                        $custom_parser: us_mo_custom_enum_parsers.parse_case_types
