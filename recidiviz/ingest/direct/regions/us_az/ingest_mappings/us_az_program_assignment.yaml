# yaml-language-server: $schema=./../../../ingest_mappings/yaml_schema/1.0.0/schema.json
manifest_language: 1.0.0
input_columns:
  program_name: STRING
  CODE: STRING
  PERSON_ID: STRING
  DOC_ID: STRING
  COMPLETION_PR_FLAG: STRING
  ENROLL_STATUS: STRING
  ASSIGNMENT_DATE: STRING
  COMPLETION_DATE: STRING
  CHANGE_EFF_DATE: STRING
  PARTICIPATION_START_DATE: STRING
  PARTICIPATION_END_DATE: STRING
  EXEMPTION: STRING
  EXEMPTION_COMMENTS: STRING
  EXEMPTION_REMOVED_DATE: DATETIME
unused_columns: []
variables:
  - discharge_indicator:
      $conditional:
        - $if:
            $and:
              - $is_null: PARTICIPATION_END_DATE
              - $is_null: COMPLETION_DATE
              - $is_null: CHANGE_EFF_DATE
          $then: $literal("NO_DISCHARGE_DATE")
        - $else: $literal("HAS_DISCHARGE_DATE")
output:
  StatePerson:
    external_ids:
      - StatePersonExternalId:
          external_id: PERSON_ID
          id_type: $literal("US_AZ_PERSON_ID")
    program_assignments:
      - StateProgramAssignment:
          external_id:
            $concat:
              $values:
                - DOC_ID
                - CODE
                - program_name
                - ASSIGNMENT_DATE
          program_id:
            $concat:
              $values:
                - CODE
                - program_name
          participation_status:
            $enum_mapping:
              $custom_parser: us_az_custom_enum_parsers.parse_program_assignment_participation_status
              $raw_text:
                $concat:
                  $values:
                    - ENROLL_STATUS
                    - $variable(discharge_indicator)
                  $separator: "@@"
          referral_date: ASSIGNMENT_DATE
          start_date: PARTICIPATION_START_DATE
          discharge_date:
            $conditional:
              - $if:
                  $is_null: PARTICIPATION_END_DATE
                $then:
                  $conditional:
                    - $if:
                        $is_null: COMPLETION_DATE
                      # This is typically the only field hydrated when someone is given an exemption
                      # after beginning a program, or if they complete but fail.
                      $then: CHANGE_EFF_DATE
                    - $else: COMPLETION_DATE
              - $else: PARTICIPATION_END_DATE
          referral_metadata:
            $normalized_values_json_dict:
              # A Y/N flag indicating whether a person successfully completed the program.
              COMPLETION_FLAG: COMPLETION_PR_FLAG
              EXEMPTION: EXEMPTION
              EXEMPTION_COMMENTS: EXEMPTION_COMMENTS
              EXEMPTION_REMOVED_DATE: EXEMPTION_REMOVED_DATE
