# yaml-language-server: $schema=./../../../ingest_mappings/yaml_schema/1.0.0/schema.json
manifest_language: 1.0.0
input_columns:
- agnt_case_updt_id
- ofndr_num
- create_by_usr_id
- create_dt
- agnt_note_title
unused_columns: []
output:
  # TODO(#10784): Remove treatment_agnt_case_updt once rerun has been completed.
  StatePerson:
    external_ids:
      - StatePersonExternalId:
          external_id: ofndr_num
          id_type: $literal("US_ID_DOC")
    program_assignments: 
      - StateProgramAssignment:
          referring_agent:
            StateAgent:
              external_id: create_by_usr_id
              agent_type: $literal_enum(StateAgentType.SUPERVISION_OFFICER)
          external_id:
            $concat:
              $values:
                - ofndr_num
                - agnt_case_updt_id
          participation_status:              
            $enum_mapping:
              $raw_text: agnt_note_title
              $custom_parser: us_id_custom_enum_parsers.participation_status_from_agnt_note_title_legacy
          discharge_reason:
            $enum_mapping:
              $raw_text: agnt_note_title
              $custom_parser: us_id_custom_enum_parsers.discharge_reason_from_agnt_note_title
          referral_date:
            $conditional:
              - $if:
                  $custom:
                    $function: us_id_custom_parsers.records_program_start
                    $args:
                      agnt_note_title: agnt_note_title
                $then: create_dt
          start_date:
            $conditional:
              - $if:
                  $custom:
                    $function: us_id_custom_parsers.records_program_start
                    $args:
                      agnt_note_title: agnt_note_title
                $then: create_dt
          discharge_date:
            $conditional:
              - $if:
                  $custom:
                    $function: us_id_custom_parsers.records_program_discharge
                    $args:
                      agnt_note_title: agnt_note_title
                $then: create_dt
