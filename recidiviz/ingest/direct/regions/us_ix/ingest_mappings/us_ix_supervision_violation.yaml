# yaml-language-server: $schema=./../../../ingest_mappings/yaml_schema/1.0.0/schema.json
# This file associates the columns outputted from the query in `view_supervision_violation` to the corresponding
# Ingest Object fields.
manifest_language: 1.0.0
input_columns:
  - OffenderId
  - ViolationId
  - EstimatedViolationDate
  - ViolatedConditions
  - ViolationTypeDesc
unused_columns:
  - ViolatedConditions # TODO(#17014): Revisit adding in Violated conditions
output:
  StatePerson:
    external_ids:
      - StatePersonExternalId:
          external_id: OffenderId
          id_type: $literal("US_IX_DOC")
    supervision_violations:
      - StateSupervisionViolation:
          external_id:
            $concat:
              $values:
                - OffenderId
                - ViolationId
          violation_date: EstimatedViolationDate # [ARS] Also consider Arrest Date?
          supervision_violation_types:
            - StateSupervisionViolationTypeEntry:
                violation_type:
                  $enum_mapping:
                    $raw_text: ViolationTypeDesc
                    $mappings:
                      StateSupervisionViolationType.ABSCONDED:
                        - Absconded # [ARS] Don't think this is used yet
                        - Non-technical - Abscond
                      StateSupervisionViolationType.LAW:
                        - Non-Technical - New Conviction
                      StateSupervisionViolationType.TECHNICAL:
                        - Technical
                      StateSupervisionViolationType.INTERNAL_UNKNOWN:
                        - Pending / In Progress
#          supervision_violated_conditions: # TODO(#17014): Revisit adding in Violated conditions
#            - $foreach:
#                $iterable:
#                  $split_json: ViolatedConditions
#                    StateSupervisionViolatedConditionEntry:
#                      condition:
#                        $json_extract:
#                          $json: $iter_item
#                          $key: condition_type_desc
