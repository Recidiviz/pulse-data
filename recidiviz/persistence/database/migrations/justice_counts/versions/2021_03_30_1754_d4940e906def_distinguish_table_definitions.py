# pylint: skip-file
"""distinguish_table_definitions

Revision ID: d4940e906def
Revises: 7709d42d2d74
Create Date: 2021-03-30 17:54:06.199520

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = "d4940e906def"
down_revision = "7709d42d2d74"
branch_labels = None
depends_on = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column(
        "report_table_definition",
        sa.Column("label", sa.String(length=255), nullable=True),
    )
    op.execute("UPDATE report_table_definition SET label = ''")
    op.alter_column("report_table_definition", "label", nullable=False)

    op.alter_column(
        "report_table_definition",
        "aggregated_dimensions",
        existing_type=postgresql.ARRAY(sa.VARCHAR(length=255)),
        nullable=False,
    )
    op.alter_column(
        "report_table_definition",
        "filtered_dimension_values",
        existing_type=postgresql.ARRAY(sa.VARCHAR(length=255)),
        nullable=False,
    )
    op.alter_column(
        "report_table_definition",
        "filtered_dimensions",
        existing_type=postgresql.ARRAY(sa.VARCHAR(length=255)),
        nullable=False,
    )
    op.alter_column(
        "report_table_definition",
        "measurement_type",
        existing_type=postgresql.ENUM(
            "INSTANT", "AVERAGE", "DELTA", "PERSON_BASED_DELTA", name="measurementtype"
        ),
        nullable=False,
    )
    op.alter_column(
        "report_table_definition",
        "metric_type",
        existing_type=postgresql.ENUM(
            "ADMISSIONS",
            "ARRESTS",
            "POPULATION",
            "REVOCATIONS",
            "RELEASES",
            name="metrictype",
        ),
        nullable=False,
    )
    op.alter_column(
        "report_table_definition",
        "system",
        existing_type=postgresql.ENUM(
            "LAW_ENFORCEMENT", "COURT_PROCESSES", "CORRECTIONS", name="system"
        ),
        nullable=False,
    )
    op.drop_constraint(
        "report_table_definition_metric_type_measurement_type_filter_key",
        "report_table_definition",
        type_="unique",
    )
    op.create_unique_constraint(
        "report_table_definition_columns_for_key",
        "report_table_definition",
        [
            "metric_type",
            "measurement_type",
            "filtered_dimensions",
            "filtered_dimension_values",
            "aggregated_dimensions",
            "label",
        ],
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(
        "report_table_definition_columns_for_key",
        "report_table_definition",
        type_="unique",
    )
    op.create_unique_constraint(
        "report_table_definition_metric_type_measurement_type_filter_key",
        "report_table_definition",
        [
            "metric_type",
            "measurement_type",
            "filtered_dimensions",
            "filtered_dimension_values",
            "aggregated_dimensions",
        ],
    )
    op.alter_column(
        "report_table_definition",
        "system",
        existing_type=postgresql.ENUM(
            "LAW_ENFORCEMENT", "COURT_PROCESSES", "CORRECTIONS", name="system"
        ),
        nullable=True,
    )
    op.alter_column(
        "report_table_definition",
        "metric_type",
        existing_type=postgresql.ENUM(
            "ADMISSIONS",
            "ARRESTS",
            "POPULATION",
            "REVOCATIONS",
            "RELEASES",
            name="metrictype",
        ),
        nullable=True,
    )
    op.alter_column(
        "report_table_definition",
        "measurement_type",
        existing_type=postgresql.ENUM(
            "INSTANT", "AVERAGE", "DELTA", "PERSON_BASED_DELTA", name="measurementtype"
        ),
        nullable=True,
    )
    op.alter_column(
        "report_table_definition",
        "filtered_dimensions",
        existing_type=postgresql.ARRAY(sa.VARCHAR(length=255)),
        nullable=True,
    )
    op.alter_column(
        "report_table_definition",
        "filtered_dimension_values",
        existing_type=postgresql.ARRAY(sa.VARCHAR(length=255)),
        nullable=True,
    )
    op.alter_column(
        "report_table_definition",
        "aggregated_dimensions",
        existing_type=postgresql.ARRAY(sa.VARCHAR(length=255)),
        nullable=True,
    )
    op.drop_column("report_table_definition", "label")
    # ### end Alembic commands ###
