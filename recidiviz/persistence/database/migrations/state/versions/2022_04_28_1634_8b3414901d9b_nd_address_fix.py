# pylint: skip-file
"""nd_address_fix

Revision ID: 8b3414901d9b
Revises: 2fe9deb1d56f
Create Date: 2022-04-28 16:34:23.997989

"""
import sqlalchemy as sa
from alembic import op

# revision identifiers, used by Alembic.
revision = "8b3414901d9b"
down_revision = "2fe9deb1d56f"
branch_labels = None
depends_on = None

UPGRADE_QUERY = """
WITH most_recent_valid_address AS (
    -- Pick the most recent history table row with a valid address.
    SELECT * FROM (
      SELECT person_id,
          current_address,
          residency_status,
          residency_status_raw_text,
          row_number() OVER (
            PARTITION BY person_id ORDER BY valid_from DESC
           ) as recency_rank
          FROM (
            SELECT *, UPPER(current_address) AS current_address_upper
            FROM state_person_history
            WHERE state_code = 'US_ND'
          ) nd_history
          WHERE
            current_address_upper NOT LIKE '%3100 RAILROAD AVE%'
            AND current_address_upper NOT LIKE '%NDSP%'
            AND current_address_upper NOT LIKE '%PO BOX 5521%'
            AND current_address_upper NOT LIKE '%440 MCKENZIE ST%'
            AND current_address_upper NOT LIKE '%ABSCOND%'
            AND current_address_upper NOT LIKE '%250 N 31ST%'
            AND current_address_upper NOT LIKE '%461 34TH ST S%'
            AND current_address_upper NOT LIKE '%1600 2ND AVE SW%'
            AND current_address_upper NOT LIKE '%702 1ST AVE S%'
            AND current_address_upper NOT LIKE '%311 S 4TH ST STE 101%'
            AND current_address_upper NOT LIKE '%222 WALNUT ST W%'
            AND current_address_upper NOT LIKE '%709 DAKOTA AVE STE D%'
            AND current_address_upper NOT LIKE '%113 MAIN AVE E STE B%'
            AND current_address_upper NOT LIKE '%712 5TH AVE%'
            AND current_address_upper NOT LIKE '%705 EAST HIGHLAND DR. SUITE B%'
            AND current_address_upper NOT LIKE '%705 E HIGHLAND DR STE B%'
            AND current_address_upper NOT LIKE '%135 SIMS ST STE 205%'
            AND current_address_upper NOT LIKE '%638 COOPER AVE%'
            AND current_address_upper NOT LIKE '%206 MAIN ST W%'
            AND current_address_upper NOT LIKE '%519 MAIN ST STE 8%'
            AND current_address_upper NOT LIKE '%115 S 5TH ST STE A%'
            AND current_address_upper NOT LIKE '%117 HWY 49%'
            -- General filter for addresses that seem to be correctional facilities of some sort
            AND current_address_upper NOT LIKE '%JAIL%'
            AND current_address_upper NOT LIKE '%PRISON%'
            AND current_address_upper NOT LIKE '%CCC%'
            AND current_address_upper NOT LIKE '%PENITENTIARY%'
    ) ranked
    WHERE recency_rank = 1
)
UPDATE state_person
SET
    current_address = history.current_address,
    residency_status = history.residency_status,
    residency_status_raw_text = history.residency_status_raw_text
FROM state_person p
LEFT JOIN 
most_recent_valid_address history
ON p.person_id = history.person_id
WHERE p.state_code = 'US_ND';
"""


def upgrade() -> None:
    with op.get_context().autocommit_block():
        op.execute(UPGRADE_QUERY)


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###
