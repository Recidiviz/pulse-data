# pylint: skip-file
"""add_deciding_staff_external_id

Revision ID: 2bfa9cac7e15
Revises: ecf3f286ba25
Create Date: 2023-09-14 15:33:20.815128

"""
import sqlalchemy as sa
from alembic import op

from recidiviz.utils.string import StrictStringFormatter

# revision identifiers, used by Alembic.
revision = "2bfa9cac7e15"
down_revision = "ecf3f286ba25"
branch_labels = None
depends_on = None


DECIDING_STAFF_CONSTRAINT = "deciding_staff_external_id_fields_consistent"

CONDITION_TEMPLATE = """
    ({id_field} IS NULL AND {id_field}_type IS NULL)
    OR ({id_field} IS NOT NULL AND {id_field}_type IS NOT NULL)
"""


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column(
        "state_supervision_violation_response",
        sa.Column(
            "deciding_staff_external_id",
            sa.String(length=255),
            nullable=True,
            comment="The external id of the staff member who made the decision(s) associated with this response. This field with the deciding_staff_external_id_type field make up a primary key for the state_staff_external_id table.",
        ),
    )
    op.add_column(
        "state_supervision_violation_response",
        sa.Column(
            "deciding_staff_external_id_type",
            sa.String(length=255),
            nullable=True,
            comment="The ID type associated with the external id of the staff member who made the decision(s) associated with this response. This field with the deciding_staff_external_id field make up a primary key for the state_staff_external_id table.",
        ),
    )
    # ### end Alembic commands ###
    op.create_check_constraint(
        constraint_name=DECIDING_STAFF_CONSTRAINT,
        table_name="state_supervision_violation_response",
        condition=StrictStringFormatter().format(
            CONDITION_TEMPLATE,
            id_field="deciding_staff_external_id",
        ),
    )


def downgrade() -> None:
    op.drop_constraint(
        constraint_name=DECIDING_STAFF_CONSTRAINT,
        table_name="state_supervision_violation_response",
        type_="check",
    )
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column(
        "state_supervision_violation_response", "deciding_staff_external_id_type"
    )
    op.drop_column("state_supervision_violation_response", "deciding_staff_external_id")
    # ### end Alembic commands ###
