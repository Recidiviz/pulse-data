# pylint: skip-file
"""add_raw_data_flash_status

Revision ID: e04bac966734
Revises: dc46a194788e
Create Date: 2024-05-02 15:09:50.361286

"""
import datetime

import sqlalchemy as sa
from alembic import op

from recidiviz.utils.string import StrictStringFormatter

# revision identifiers, used by Alembic.
revision = "e04bac966734"
down_revision = "dc46a194788e"
branch_labels = None
depends_on = None

active_state_codes = [
    "US_AR",
    "US_AZ",
    "US_CA",
    "US_CO",
    "US_IA",
    "US_ID",
    "US_IX",
    "US_ME",
    "US_MI",
    "US_MO",
    "US_NC",
    "US_ND",
    "US_OR",
    "US_OZ",
    "US_PA",
    "US_TN",
]


HYDRATION_QUERY = """INSERT INTO direct_ingest_raw_data_flash_status (region_code, status_timestamp, flashing_in_progress) VALUES
{all_rows};
"""


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table(
        "direct_ingest_raw_data_flash_status",
        sa.Column("region_code", sa.String(length=255), nullable=False),
        sa.Column("status_timestamp", sa.DateTime(timezone=True), nullable=False),
        sa.Column("flashing_in_progress", sa.Boolean(), nullable=False),
        sa.PrimaryKeyConstraint("region_code", "status_timestamp"),
    )
    op.create_index(
        op.f("ix_direct_ingest_raw_data_flash_status_region_code"),
        "direct_ingest_raw_data_flash_status",
        ["region_code"],
        unique=False,
    )

    timestamp = datetime.datetime.now(tz=datetime.UTC).isoformat()
    all_rows = [
        f"('{state_code}', '{timestamp}', '0')" for state_code in active_state_codes
    ]

    op.execute(
        StrictStringFormatter().format(HYDRATION_QUERY, all_rows=",\n".join(all_rows))
    )

    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    all_state_codes_str = [f"'{a}'" for a in active_state_codes]
    op.execute(
        f"""
            DELETE FROM direct_ingest_raw_data_flash_status
            WHERE region_code in ({", ".join(all_state_codes_str)});
        """
    )
    op.drop_index(
        op.f("ix_direct_ingest_raw_data_flash_status_region_code"),
        table_name="direct_ingest_raw_data_flash_status",
    )
    op.drop_table("direct_ingest_raw_data_flash_status")
    # ### end Alembic commands ###
