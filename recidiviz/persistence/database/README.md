# Database

## Migrations

### General Warnings

- Do not make any changes to the schema file without also updating the database according to the workflow below. The schema and the database must not be out of sync.

- A migration should consist of a single change to the schema (a single change meaning a single conceptual change, which may consist of multiple update statements). Do not group changes.

- It is the responsibility of the person making the migration to ensure that the prod release and the database are compatible at each step of the migration. This may require performing the migration in stages (e.g. temporarily allowing double writes while replacing a column with a new one).

### Database Constraints

- For historical tables, the primary key exists only due to requirements of SQLAlchemy, and should never be used or referenced by another table.

- If a column is added or removed from a table, it must also be added or removed from the corresponding historical table.

- Foreign key constraints cannot reference historical tables because their keys are not unique.

- If adding a column of type `String`, the length must be specified (this keeps the schema portable, as certain SQL implementations require an explicit length for `String` columns).

- Do not explicitly set the column name argument for a column unless it is required to give a column the same name as a Python reserved keyword.

### Migration Workflow

#### TL;WR

1. Get dev database schema in sync with prod database schema.

2. Generate the migration against the prod database.

3. Run the migration against the dev database. Make sure it looks as expected.

4. Check in the schema file changes and migration.

5.
    - For adding column/value: run migration against prod database, then cut a new prod release.
    - For removing column/value: cut a new prod release, then run migration against prod database.

6. Give yourself a pat on the head.

#### Environment Variables

Environment variables required for interacting with the **DEV** database:

- `SQLALCHEMY_USE_SSL`: must be set to 0

- `SQLALCHEMY_DB_USER`: name of database role with privileges to update schema

- `SQLALCHEMY_DB_PASSWORD`: password for that role

- `SQLALCHEMY_DB_HOST`: IP address of database instance

- `SQLALCHEMY_DB_NAME`: name of database within database instance

Environment variables required for interacting with the **PROD** database:

- `SQLALCHEMY_USE_SSL`: must be set to 1

- All other fields required by dev database

- `SQLALCHEMY_SSL_KEY_PATH`: path to location of SSL key on local machine

- `SQLALCHEMY_SSL_CERT_PATH`: path to location of SSL certificate on local machine

#### Workflow

NOTE: All commands below should be run from `recidiviz/persistence/database` directory, where `alembic.ini` is located.

1. Set environment variables to point to **DEV** database. Run `alembic revision --autogenerate -m "<MIGRATION_NAME>"`. This will generate an initial migration to resolve any differences between the dev and prod schemas.

2. Run `alembic upgrade head`. This will update the dev database to match the prod schema.

3. In `recidiviz/persistence/database/migrations/versions`, delete the migration that was just run. As a temporary migration used to update dev only, it should not be checked in.

4. Update `recidiviz/persistence/database/schema.py` with the schema change.

5. Set environment variables to point to **PROD** database. Run `alembic revision --autogenerate -m "<MIGRATION_NAME>"`. This will generate the prod migration for the new schema change.

6. In `recidiviz/persistence/database/migrations/versions`, inspect the new migration to ensure the autogenerated code is correct.

7. Set environment variables to point to **DEV** database. Run `alembic upgrade head` to run the prod migration against the dev database. Inspect the dev database and ensure the change ran as expected.

8. Check in schema file change and migration for review. **NOTE**: Once this change is checked in, additional prod releases are blocked until the remainder of the workflow is completed.

The order of the last two steps depends on the type of migration.

- For **adding** a column or value:

    1. Ensure local branch is up-to-date (specifically confirming that no other migrations have been checked in). Set environment variables to point to **PROD** database. Run `alembic upgrade head` to update the prod database with the schema change.

    2. Make a new prod release containing the updated schema file.

- For **removing** a column or value, perform the same steps in reverse order (i.e. make the new prod release before running the migration against the prod database).
